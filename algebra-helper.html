<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IB Math Trainer (Fast Response)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: {fontCache: 'global'},
      startup: { typeset: false }
    };
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        .debug-correct { border: 2px dashed #facc15 !important; position: relative; }
        .debug-correct::after { content: "‚úì DEBUG"; position: absolute; top: -10px; right: 10px; background: #facc15; color: black; font-size: 9px; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Floating Value Animation */
        .float-up { animation: floatUp 1s ease-out forwards; color: #4ade80; }
        .float-down { animation: floatDown 1s ease-out forwards; color: #f87171; }
        
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }
        @keyframes floatDown { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(20px); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col items-center justify-center p-4">

    <div id="app" class="w-full max-w-2xl bg-gray-800 rounded-xl shadow-2xl border border-gray-700 overflow-hidden">
        
        <!-- HEADER -->
        <div class="bg-gray-750 p-4 border-b border-gray-700 flex justify-between items-center text-sm relative">
            <div class="flex flex-col w-1/3">
                <span class="text-gray-400 text-[10px] uppercase">Level</span> 
                <div class="flex items-center gap-2">
                    <span id="level-display" class="text-xl font-bold text-yellow-400 transition-all duration-300">5.0</span>
                    <!-- The Floating Delta Container -->
                    <span id="delta-display" class="text-sm font-bold absolute left-16 top-8"></span>
                </div>
            </div>
            
            <div class="flex flex-col items-center w-1/3">
                <div id="mode-badge" class="px-3 py-1 bg-blue-900 text-blue-200 text-xs font-bold uppercase rounded-full tracking-wide text-center">
                    Calibration
                </div>
                <!-- Range Indicator -->
                <div id="search-range" class="text-[10px] text-gray-400 mt-1 font-mono hidden">
                    Window: 0.0 - 10.0
                </div>
                <!-- Streak Fire -->
                <div id="streak-indicator" class="hidden text-orange-500 font-bold text-xs mt-1">
                    üî•üî• TURBO MODE
                </div>
            </div>

            <div class="text-right flex flex-col items-end w-1/3">
                <span class="text-gray-400 text-[10px] uppercase">Last 5 Avg</span> 
                <span id="accuracy-display" class="text-xl font-bold text-gray-500">--%</span>
            </div>
        </div>

        <!-- MAIN AREA -->
        <div class="p-8 min-h-[350px] flex flex-col items-center relative bg-gray-800">
            <div id="calc-indicator" class="absolute top-4 right-4 opacity-50"></div>

            <div class="w-full my-6 flex flex-col items-center">
                <div id="instruction-text" class="text-blue-400 font-bold uppercase tracking-widest text-sm mb-6">Loading engine...</div>
                <div id="question-math" class="text-3xl md:text-5xl text-white font-serif flex items-center justify-center min-h-[5rem]">
                    <span class="animate-pulse text-base text-gray-500">Waiting for MathJax...</span>
                </div>
            </div>
            
            <div id="explanation-box" class="hidden w-full mt-6 p-4 bg-gray-900 rounded border-l-4 border-yellow-500 text-left fade-in">
                <p class="text-yellow-500 font-bold text-xs uppercase mb-2">Correction</p>
                <div id="explanation-text" class="text-gray-300 text-base leading-relaxed"></div>
            </div>
        </div>

        <!-- CONTROLS: CALIBRATION -->
        <div id="controls-calibration" class="grid grid-cols-3 divide-x divide-gray-700 border-t border-gray-700 bg-gray-750 h-24">
            <button onclick="APP.handleCalibration('fail')" class="hover:bg-red-900/30 text-gray-400 hover:text-red-300 font-bold flex flex-col items-center justify-center">
                <span>Don't Know</span>
                <span class="text-[10px] font-normal opacity-50 mt-1">Too Hard</span>
            </button>
            <button onclick="APP.handleCalibration('doubt')" class="hover:bg-yellow-900/30 text-gray-400 hover:text-yellow-300 font-bold flex flex-col items-center justify-center">
                <span>Not Sure</span>
                <span class="text-[10px] font-normal opacity-50 mt-1">Hold</span>
            </button>
            <button onclick="APP.handleCalibration('pass')" class="hover:bg-green-900/30 text-gray-400 hover:text-green-300 font-bold flex flex-col items-center justify-center">
                <span>I Know This</span>
                <span class="text-[10px] font-normal opacity-50 mt-1">Too Easy</span>
            </button>
        </div>

        <!-- CONTROLS: DRILL -->
        <div id="controls-drill" class="hidden border-t border-gray-700 bg-gray-750 p-6 fade-in">
            <div id="mc-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            <button id="next-btn" onclick="APP.nextQuestion()" class="hidden w-full mt-4 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow-lg">Next Problem ‚Üí</button>
        </div>
    </div>

    <script>
        const DEBUG_MODE = false; 

        const APP = {
            level: 5.0, 
            streak: 0,
            mode: 'calibration',
            history: [],
            
            // Calibration State
            cMin: 0, cMax: 10,
            
            init: function() { 
                if (window.MathJax && window.MathJax.typesetPromise) this.nextQuestion();
                else setTimeout(() => this.init(), 100);
            },

            nextQuestion: function() {
                // UI Reset
                document.getElementById('explanation-box').classList.add('hidden');
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('mc-options').innerHTML = '';
                document.getElementById('delta-display').innerHTML = ''; // clear anim
                
                this.updateUI();

                // Generate Question
                this.currentQ = Generator.getQuestion(this.level);
                this.startTime = Date.now();

                // Render
                document.getElementById('instruction-text').innerText = this.currentQ.instruction;
                const qDiv = document.getElementById('question-math');
                qDiv.innerHTML = `\\[ ${this.currentQ.tex} \\]`;
                MathJax.typesetPromise([qDiv]);

                // Icon
                document.getElementById('calc-indicator').innerHTML = this.currentQ.calc 
                    ? '<span class="text-2xl">üì±</span><div class="text-[8px] text-green-500 font-bold">Calc</div>' 
                    : '<span class="text-2xl text-red-500 relative">‚úèÔ∏è</span><div class="text-[8px] text-red-500 font-bold">No Calc</div>';

                // Mode View
                document.getElementById('controls-calibration').classList.toggle('hidden', this.mode === 'drill');
                document.getElementById('controls-drill').classList.toggle('hidden', this.mode === 'calibration');
                
                if (this.mode === 'drill') this.setupDrillUI();
            },

            updateUI: function() {
                document.getElementById('level-display').innerText = this.level.toFixed(1);
                
                // Calibration Window Display
                const rangeDiv = document.getElementById('search-range');
                if (this.mode === 'calibration') {
                    rangeDiv.classList.remove('hidden');
                    rangeDiv.innerText = `Range: ${this.cMin.toFixed(1)} - ${this.cMax.toFixed(1)}`;
                } else {
                    rangeDiv.classList.add('hidden');
                }
                
                // Show Turbo Fire if streak high
                const fire = document.getElementById('streak-indicator');
                if (this.streak >= 3) fire.classList.remove('hidden');
                else fire.classList.add('hidden');

                // Accuracy (Last 5 only for speed)
                const accEl = document.getElementById('accuracy-display');
                if (this.history.length > 0) {
                    // Only take last 5
                    const subset = this.history.slice(-5);
                    const avg = Math.round((subset.reduce((a,b)=>a+b,0)/subset.length)*100);
                    accEl.innerText = avg + "%";
                    accEl.className = avg >= 80 ? "text-xl font-bold text-green-400" 
                                    : avg < 50 ? "text-xl font-bold text-red-400" 
                                    : "text-xl font-bold text-yellow-400";
                } else {
                    accEl.innerText = "--%";
                }
            },

            // --- MOMENTUM LOGIC (DRILL) ---
            setupDrillUI: function() {
                const container = document.getElementById('mc-options');
                let opts = [
                    { val: this.currentQ.displayAnswer, correct: true },
                    { val: this.currentQ.distractors[0], correct: false },
                    { val: this.currentQ.distractors[1], correct: false },
                    { val: this.currentQ.distractors[2], correct: false }
                ].sort(() => Math.random() - 0.5);

                opts.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "p-4 bg-gray-700 hover:bg-gray-600 rounded text-lg border border-gray-600 transition flex items-center justify-center min-h-[60px]";
                    if (DEBUG_MODE && opt.correct) btn.classList.add('debug-correct');
                    btn.onclick = () => this.handleDrillAnswer(btn, opt.correct);
                    btn.innerHTML = `\\( ${opt.val} \\)`;
                    container.appendChild(btn);
                });
                MathJax.typesetPromise([container]);
            },

            handleDrillAnswer: function(btn, isCorrect) {
                // Disable all
                document.getElementById('mc-options').querySelectorAll('button').forEach(b => b.disabled=true);

                let delta = 0;

                if (isCorrect) {
                    btn.className = "p-4 bg-green-600 rounded text-lg border border-green-400 flex items-center justify-center min-h-[60px]";
                    this.history.push(1);
                    
                    // --- THE FIX: MOMENTUM LOGIC ---
                    this.streak++;
                    
                    if (this.streak >= 3) delta = 0.5; // Acceleration
                    else delta = 0.2; // Base movement

                } else {
                    btn.className = "p-4 bg-red-600 rounded text-lg border border-red-400 flex items-center justify-center min-h-[60px]";
                    this.history.push(0);
                    
                    // Frustration Breaker
                    if (this.streak <= 0) delta = -0.8; // Second wrong answer drops hard
                    else delta = -0.3; // First wrong answer drops distinct amount
                    
                    this.streak = 0; // Reset streak
                    
                    // Show Explanation
                    const box = document.getElementById('explanation-box');
                    box.classList.remove('hidden');
                    document.getElementById('explanation-text').innerHTML = this.currentQ.explanation;
                    MathJax.typesetPromise([box]);
                }
                
                // Update and Animate Level
                this.applyLevelChange(delta);
                
                document.getElementById('next-btn').classList.remove('hidden');
            },

            applyLevelChange: function(delta) {
                // 1. Update data
                this.level = Math.max(1, Math.min(10, this.level + delta));
                
                // 2. Animate visually
                const deltaEl = document.getElementById('delta-display');
                deltaEl.innerText = (delta > 0 ? '+' : '') + delta.toFixed(1);
                deltaEl.className = delta > 0 
                    ? "text-xl font-bold absolute left-16 top-0 float-up" 
                    : "text-xl font-bold absolute left-16 top-0 float-down";
                
                // Update text instantly
                document.getElementById('level-display').innerText = this.level.toFixed(1);
            },

            // --- BINARY CHOP (CALIBRATION) ---
            handleCalibration: function(action) {
                const timeTaken = (Date.now() - this.startTime) / 1000;
                
                // Binary Logic
                if (action === 'pass') {
                    if(timeTaken > 20) { 
                        // Too slow - counts as Not Sure
                        this.cMax = this.level;
                    } else {
                        this.cMin = this.level;
                    }
                } else {
                    // Fail or Doubt
                    this.cMax = this.level;
                }

                // Check convergence
                if ((this.cMax - this.cMin) < 1.5) {
                    // Ready to drill. Start slightly below found level.
                    this.level = Math.max(1, this.cMin - 1.0); 
                    this.mode = 'drill';
                    // Visual update
                    document.getElementById('mode-badge').innerText = "Drill Phase";
                    document.getElementById('mode-badge').className = "px-3 py-1 bg-purple-900 text-purple-200 text-xs font-bold uppercase rounded-full tracking-wide";
                } else {
                    // Next step in binary search
                    const nextVal = (this.cMin + this.cMax) / 2;
                    this.level = Math.round(nextVal * 2) / 2; // Step 0.5
                }
                this.nextQuestion();
            }
        };

        // --- GENERATOR ---
        const Generator = {
            rInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
            getQuestion: function(level) {
                const band = Math.round(level);
                if (band <= 2) return this.lvl1();
                if (band <= 4) return this.lvl2();
                if (band <= 6) return this.lvl3();
                if (band <= 8) return this.lvl4();
                return this.lvl5();
            },
            lvl1: function() {
                const a=this.rInt(2,9), x=this.rInt(2,9);
                return { tex: `${a}x = ${a*x}`, instruction: "Solve for x", displayAnswer:`x=${x}`, distractors:[`x=${x+1}`,`x=${a}`,`x=${x-1}`], explanation:`Divide by ${a}`, calc:false };
            },
            lvl2: function() {
                const a=this.rInt(2,9), b=this.rInt(2,9), x=this.rInt(2,9); 
                return { tex: `${a}x + ${b} = ${a*x+b}`, instruction: "Solve for x", displayAnswer:`x=${x}`, distractors:[`x=${x+1}`,`x=${-x}`,`x=${b}`], explanation:`Subtract ${b}, Divide by ${a}`, calc:false };
            },
            lvl3: function() {
                const a=this.rInt(2,5), b=this.rInt(2,8);
                return { tex: `${a}(x + ${b})`, instruction: "Expand", displayAnswer:`${a}x + ${a*b}`, distractors:[`${a}x+${b}`,`x+${a*b}`,`${a}x^2+${b}`], explanation:`Multiply ${a} by each inner term`, calc:false };
            },
            lvl4: function() {
                const a=this.rInt(1,5), b=this.rInt(2,6);
                return { tex: `x^2 + ${a+b}x + ${a*b}`, instruction: "Factorise", displayAnswer:`(x+${a})(x+${b})`, distractors:[`(x+${a+b})(x+${a*b})`, `x(x+${a+b})`, `(x-${a})(x-${b})`], explanation:`Find factors of ${a*b} adding to ${a+b}`, calc:false };
            },
            lvl5: function() {
                const a=this.rInt(2,5), n=this.rInt(2,4);
                return { tex: `f(x) = ${a}x^{${n}}`, instruction: "Find f'(x)", displayAnswer:`${a*n}x^{${n-1}}`, distractors:[`${a*n}x^{${n}}`,`${a}x^{${n-1}}`,`${n}x^{${a}}`], explanation:`Power rule: $nx^{n-1}$`, calc:false };
            }
        };

        window.onload = () => APP.init();
    </script>
</body>
</html>
                    